# INDEXER - program to insert HTML index files in Elliott Archive "Manuals"
# directory tree
# Andrew Herbert 16/07/2020

import os.path
import sys

mb = 1024 *1024

def fullName (path, name):
    return path + '/' + name

def indexPath (path, name, depth):

    filenames = os.listdir (path)
    filenames.sort ()

    if depth == 1:
        for n in filenames:
            pn = fullName (path, n)
            if os.path.isdir (pn):
                indexPath (pn, n, depth+1)
        return

    outfile = open (path + '/index.htm', 'w')
    outfile.write ('<!DOCTYPE html>\n')
    outfile.write ('<html>\n')
    outfile.write ('<body>\n')
    outfile.write ('<H1>Contents of ' + name + '</H1>')
    outfile.write ('<table>\n')

    count = 0

    for n in filenames:

        if n.startswith ('.'):
            continue

        pn = fullName (path, n)
        nl = n.lower()

        if nl == 'index.htm' or nl == 'index.htm.old' or nl == 'indexer.py':
            continue

        if count % 3 == 0:
            outfile.write ('<tr>\n')

        if os.path.isfile (pn):
            if pn.endswith('.pdf') or pn.endswith('.PDF'):
                if os.path.getsize(pn) / mb >= 100:
                    newpn = pn[:len(pn)-4] + '.PDF'
                    os.rename(pn, newpn)
                else:
                    newpn = pn[:len(pn)-4] + '.pdf'
                    os.rename(pn, newpn)
            outfile.write ('<td style="padding:10px"><a href="' +
                               n + '">' + n + '</a></td>\n')

        elif os.path.isdir (pn):
            outfile.write ('<td style="padding:10px"><a href="' +
                               n + '/index.htm">' + n + '</a></td>\n')
            indexPath (pn, n, depth+1)

        else:
            continue

        if count % 3 == 2:
            outfile.write ('</tr>\n')

        count = count + 1

    if count % 3 != 2:
        outfile.write ('</tr>\n')

    outfile.write ('</table>\n')
    outfile.write ('</body>\n')
    outfile.write ('</html>\n')
    outfile.close ()

# Main program
indexPath ('.', 'Elliott Documents', 1)

